<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bem-vindo! - Montador de Sermões 3.2</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="/manifest.json">
    
    <!-- Link para o script de instalação centralizado -->
    <script src="pwa-installer.js" defer></script>
</head>
<body>
    <header>
        <img src="https://cdn.glitch.global/db74bd9b-d683-421c-9223-f55b917c9dce/logo.png?v=1734385573934" alt="Logo do Montador de Sermões 3.2" class="logo">
    </header>
    
    <div class="welcome-container">
        <h1>Parabéns!</h1>
        <p>Seja bem-vindo ao Montador de Sermões 3.2. Para a melhor experiência, recomendamos instalar o atalho do aplicativo em seu dispositivo.</p>
        
        <button id="start-button" class="start-button">Começar a Usar</button>
    </div>

    <script>
        // CORREÇÃO COMPLETA DA LÓGICA DE INSTALAÇÃO E REDIRECIONAMENTO

        const startButton = document.getElementById('start-button');
        let isInstallable = false;

        // Função para redirecionar o usuário para a aplicação principal
        function goToApp() {
            window.location.href = '/app';
        }

        // Função para atualizar a aparência e o estado do botão
        function updateButtonState() {
            // A variável 'deferredPrompt' é definida pelo pwa-installer.js
            if (window.deferredPrompt) {
                isInstallable = true;
                startButton.innerText = 'Instalar e Começar';
            } else {
                isInstallable = false;
                startButton.innerText = 'Começar a Usar';
            }
        }
        
        // Ouve o evento 'load' para garantir que tudo foi carregado
        window.addEventListener('load', () => {
          // O pwa-installer.js já capturou o evento, então podemos verificar seu estado.
          // Damos um pequeno tempo para garantir que o script tenha rodado.
          setTimeout(updateButtonState, 200);
        });

        // Lógica de clique do botão
        startButton.addEventListener('click', async () => {
            // Se o app não for instalável, simplesmente redireciona
            if (!isInstallable || !window.deferredPrompt) {
                goToApp();
                return;
            }

            // Se for instalável, primeiro mostra o prompt
            window.deferredPrompt.prompt();
            
            // Aguarda a escolha do usuário. O código só continua DEPOIS que o pop-up for fechado.
            const { outcome } = await window.deferredPrompt.userChoice;
            
            console.log(`Resultado da instalação: ${outcome}`);
            
            // Limpa a referência para que o prompt não seja mostrado novamente
            window.deferredPrompt = null;
            isInstallable = false;
            
            // AGORA, após tudo ter sido resolvido, redireciona o usuário.
            goToApp();
        });
    </script>
</body>
</html>
